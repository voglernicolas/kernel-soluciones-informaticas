
@page "/search"
@attribute [Authorize]
@inject WebApp.Services.SearchService SearchSvc

<h3>Búsqueda de instrumental</h3>

<div>
  <InputText @bind-Value="term" placeholder="Nombre, tipo o código..." />
  <button @onclick="DoSearch" disabled="@busy">Buscar</button>
</div>

@if (busy) { <p>Cargando…</p> }

@if (ran && (results is null || results.Count == 0))
{
  <p>No hay resultados para "@term".</p>
}

@if (results?.Count > 0)
{
  <table>
    <thead><tr><th>Instrumento</th><th>Tipo</th><th>Código</th><th>Cajas</th></tr></thead>
    <tbody>
      @foreach (var r in results)
      {
        <tr>
          <td>@r.Nombre</td>
          <td>@r.Tipo</td>
          <td>@r.CodigoInterno</td>
          <td>
            @if (r.Cajas.Count == 0) { <span>—</span> }
            else
            {
              <ul>
                @foreach (var c in r.Cajas)
                {
                  <li><a href="@($"/boxes/{c.BoxId}")">@c.Nombre</a> (@c.Especialidad) × @c.Cantidad</li>
                }
              </ul>
            }
          </td>
        </tr>
      }
    </tbody>
  </table>
}

@code {
  private string? term;
  private bool busy;
  private bool ran;
  private List<WebApp.Services.InstrumentSearchResult>? results;

  private async Task DoSearch()
  {
    busy = true; ran = true;
    results = await SearchSvc.SearchAsync(term);
    busy = false;
  }
}
